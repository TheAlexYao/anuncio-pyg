
## 2026-02-13 18:24 - US-003: Create crypto encrypt/decrypt helpers
- Created convex/lib/crypto.ts with encrypt/decrypt using aes-256-gcm per docs/credentials.md pattern
- Format: iv_hex:tag_hex:ciphertext_hex, AES-256-GCM with random 16-byte IV
- Created convex/lib/crypto.test.ts with 9 tests: round-trip, empty string, unicode, long text, format validation, random IV uniqueness, wrong key throws, tampered ciphertext throws, invalid format throws
- All 9 tests pass, typecheck clean (only pre-existing errors in test files)
- Files: convex/lib/crypto.ts, convex/lib/crypto.test.ts
- **Learnings:** Empty string encrypts to empty hex — use `=== undefined` not `!val` for format validation since empty string is falsy
---

## 2026-02-13 19:20 - US-004: Create Meta Lead Retrieval API client helper
- Created convex/lib/metaLeads.ts with getPages, getLeadForms, getLeadsByForm functions
- getPages: GET /v21.0/me/accounts?fields=id,name
- getLeadForms: GET /v21.0/{pageId}/leadgen_forms?fields=id,name,status
- getLeadsByForm: GET /v21.0/{formId}/leads?fields=id,created_time,field_data with optional since filter
- Exported types: MetaPage, MetaLeadForm, MetaLead
- Generic metaGet helper handles auth token injection and Meta error parsing
- Created convex/lib/metaLeads.test.ts with 14 tests: URL construction (3), token inclusion, data return (3), error handling (3), since filter (2), non-Meta error format, exports
- All 14 tests pass, no new typecheck errors
- Files: convex/lib/metaLeads.ts, convex/lib/metaLeads.test.ts
- **Learnings:** Mock fetch globally with beforeEach/afterEach restore pattern; Meta filtering uses JSON array in query param
---

## 2026-02-13 20:06 - US-008: Create HTTP action for OAuth callback endpoint
- Created convex/http.ts with httpRouter, GET /auth/google/callback route
- Handler extracts code and state from query params, parses state for userId
- Calls exchangeCodeForTokens internal action, redirects to /settings/connections with status
- Handles missing code, missing state, invalid state, and exchange errors gracefully (all 302 redirects)
- Created convex/google/exchangeCode.ts with exchangeCodeForTokens internal action
- Exchange action POSTs to Google token endpoint, encrypts tokens, stores via storeTokens mutation
- Exported pure helpers: buildRedirectUrl, parseState, buildExchangeBody, parseExchangeResponse
- Created convex/http.test.ts (12 tests) and convex/google/exchangeCode.test.ts (13 tests) — 25 total, all pass
- Convex codegen clean
- Files: convex/http.ts, convex/http.test.ts, convex/google/exchangeCode.ts, convex/google/exchangeCode.test.ts
- **Learnings:** Convex httpRouter uses `httpAction` from _generated/server; httpAction handler receives (ctx, request) where request is a standard Request object
---
