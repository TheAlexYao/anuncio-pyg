
## 2026-02-12 22:50 - US-003: Add internal mutations for storing and updating OAuth tokens
- Created convex/auth/tokens.ts with storeTokens (internalMutation), updateTokens (internalMutation), getTokens (internalQuery)
- storeTokens: upserts user_auth by userId+platform, accepts all required fields
- updateTokens: patches encryptedAccessToken and tokenExpiresAt on existing record
- getTokens: fetches user_auth by userId and platform using by_user_platform index
- All functions use v validators
- Created convex/auth/tokens.test.ts with 11 tests: export checks, distinctness, args validation
- All 11 tests pass
- Fixed: ran convex codegen to regenerate api.d.ts and dataModel.d.ts with proper module references
- Typecheck passes (only 2 pre-existing errors in tests/schema.test.ts)
- Files: convex/auth/tokens.ts, convex/auth/tokens.test.ts, convex/_generated/api.d.ts, convex/_generated/dataModel.d.ts
- **Learnings:** Convex codegen must be run after adding new modules; ApiFromModules<{}> means codegen is stale
---

## 2026-02-13 04:02 - US-005: Build Google OAuth authorization URL generator action
- Created convex/google/oauth.ts with generateAuthUrl action
- Builds Google OAuth URL with client_id, redirect_uri, response_type=code, access_type=offline, prompt=consent, state
- Scopes: adwords + analytics.readonly
- Reads GOOGLE_CLIENT_ID and GOOGLE_REDIRECT_URI from process.env
- Created convex/google/oauth.test.ts with 12 tests: URL structure, all params, scopes, state preservation, special chars, exports
- All 12 tests pass
- Files: convex/google/oauth.ts, convex/google/oauth.test.ts
- **Learnings:** Google OAuth module follows same "use node" pattern as meta.ts
---

## 2026-02-13 19:56 - US-007: Build token refresh action
- Added refreshAccessToken internalAction to convex/google/oauth.ts
- Reads user_auth by ID, decrypts refresh token, POSTs to Google token endpoint
- Encrypts new access_token and calls updateTokens mutation
- Added getValidAccessToken internalAction with 60s expiry buffer
- Added getTokensById internalQuery to convex/auth/tokens.ts
- Fixed convex/lib/crypto.ts missing "use node" directive (was already broken before)
- Created convex/google/oauth.refresh.test.ts with 18 tests
- Pure helper pattern: isTokenExpired, buildRefreshBody, parseTokenResponse exported for testing
- **Learnings:** Convex lib files using Node APIs need "use node" directive even if only imported by action files; pure helper extraction pattern continues to work well for testability
---
