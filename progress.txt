
## 2026-02-13 18:24 - US-003: Create crypto encrypt/decrypt helpers
- Created convex/lib/crypto.ts with encrypt/decrypt using aes-256-gcm per docs/credentials.md pattern
- Format: iv_hex:tag_hex:ciphertext_hex, AES-256-GCM with random 16-byte IV
- Created convex/lib/crypto.test.ts with 9 tests: round-trip, empty string, unicode, long text, format validation, random IV uniqueness, wrong key throws, tampered ciphertext throws, invalid format throws
- All 9 tests pass, typecheck clean (only pre-existing errors in test files)
- Files: convex/lib/crypto.ts, convex/lib/crypto.test.ts
- **Learnings:** Empty string encrypts to empty hex — use `=== undefined` not `!val` for format validation since empty string is falsy
---

## 2026-02-13 19:20 - US-004: Create Meta Lead Retrieval API client helper
- Created convex/lib/metaLeads.ts with getPages, getLeadForms, getLeadsByForm functions
- getPages: GET /v21.0/me/accounts?fields=id,name
- getLeadForms: GET /v21.0/{pageId}/leadgen_forms?fields=id,name,status
- getLeadsByForm: GET /v21.0/{formId}/leads?fields=id,created_time,field_data with optional since filter
- Exported types: MetaPage, MetaLeadForm, MetaLead
- Generic metaGet helper handles auth token injection and Meta error parsing
- Created convex/lib/metaLeads.test.ts with 14 tests: URL construction (3), token inclusion, data return (3), error handling (3), since filter (2), non-Meta error format, exports
- All 14 tests pass, no new typecheck errors
- Files: convex/lib/metaLeads.ts, convex/lib/metaLeads.test.ts
- **Learnings:** Mock fetch globally with beforeEach/afterEach restore pattern; Meta filtering uses JSON array in query param
---

## 2026-02-13 20:06 - US-008: Create HTTP action for OAuth callback endpoint
- Created convex/http.ts with httpRouter, GET /auth/google/callback route
- Handler extracts code and state from query params, parses state for userId
- Calls exchangeCodeForTokens internal action, redirects to /settings/connections with status
- Handles missing code, missing state, invalid state, and exchange errors gracefully (all 302 redirects)
- Created convex/google/exchangeCode.ts with exchangeCodeForTokens internal action
- Exchange action POSTs to Google token endpoint, encrypts tokens, stores via storeTokens mutation
- Exported pure helpers: buildRedirectUrl, parseState, buildExchangeBody, parseExchangeResponse
- Created convex/http.test.ts (12 tests) and convex/google/exchangeCode.test.ts (13 tests) — 25 total, all pass
- Convex codegen clean
- Files: convex/http.ts, convex/http.test.ts, convex/google/exchangeCode.ts, convex/google/exchangeCode.test.ts
- **Learnings:** Convex httpRouter uses `httpAction` from _generated/server; httpAction handler receives (ctx, request) where request is a standard Request object
---

## 2026-02-13 20:08 - US-006: Create Meta lead sync action
- Created convex/metaLeadSync.ts with syncLeads internalAction
- syncLeads: queries all meta connectedAccounts, decrypts tokens, calls getPages → getLeadForms → getLeadsByForm (90-day filter), upserts each lead
- Helper mutations: createSyncLog, completeSyncLog, upsertLead (dedup by platformLeadId index)
- Helper query: getMetaConnectedAccounts (filters platform='meta')
- Error isolation: try/catch per account, one failing account doesn't stop others
- Sync log created at start, completed with success/error status
- Created convex/metaLeadSync.test.ts with 11 tests: 5 export checks, 2 cutoff calculation, 2 date parsing, 1 error isolation, 1 dedup pattern
- All 11 tests pass, no new typecheck errors
- Files: convex/metaLeadSync.ts, convex/metaLeadSync.test.ts
- **Learnings:** Convex generated types may not include new tables until `npx convex dev` runs — use `as any` casts for index queries on newly-added tables
---

## 2026-02-14 03:03 - US-005: Create internal mutations for lead upsert with deduplication
- Created convex/leads.ts with 3 internal mutations: upsertLead, createSyncLog, completeSyncLog
- upsertLead queries by_platform_lead index, skips insert if lead exists, returns { inserted: boolean }
- createSyncLog inserts leadSyncLog with status 'running', leadsFound/leadsCreated 0
- completeSyncLog patches log with final status, counts, completedAt, optional error
- All use v validators for args, internalMutation (not client-exposed)
- Used (ctx.db as any) cast since codegen can't run (pre-existing crypto import issue)
- Created convex/leads.test.ts with 7 tests: export checks (4), type checks (3)
- All 7 tests pass, no new typecheck errors
- Files: convex/leads.ts, convex/leads.test.ts
- **Learnings:** Convex internalMutation exports are functions (typeof === 'function'), not objects
---

## 2026-02-14 06:23 - US-008: Set up cron job for 15-minute lead sync
- Created `convex/crons.ts` with cronJobs() config
- Scheduled `meta-lead-sync` interval every 15 minutes calling `internal.metaLeadSync.syncLeads`
- Files: convex/crons.ts, convex/crons.test.ts
- **Learnings:** Crons use `cronJobs()` from `convex/server`, import `internal` for internal actions, pattern matches docs/convex.md
---
